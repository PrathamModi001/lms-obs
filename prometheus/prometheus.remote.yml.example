# =============================================================================
# Prometheus Configuration for REMOTE LMS Backend
# =============================================================================
# Use this configuration when:
# - Backend/Frontend/Worker are deployed on a remote server
# - Observability stack (Prometheus/Grafana/Alertmanager) runs locally
#
# Setup Steps:
# 1. Copy this file to prometheus.yml
# 2. Replace YOUR_SERVER_DOMAIN with your actual domain/IP
# 3. Replace YOUR_API_KEY with your HEADERSAPIKEY from backend .env
# 4. Ensure your server firewall allows your local IP to access port 443/3000
# =============================================================================

global:
    scrape_interval: 15s
    evaluation_interval: 15s
    scrape_timeout: 10s

    external_labels:
        monitor: "lms-monitor"
        environment: "production"

alerting:
    alertmanagers:
        - static_configs:
              - targets:
                    - alertmanager:9093
          scheme: http
          timeout: 10s

rule_files:
    - "/etc/prometheus/alerts.yml"
    - "/etc/prometheus/alerts_comprehensive.yml"
    - "/etc/prometheus/recording_rules.yml"

scrape_configs:
    # ==========================================================================
    # LMS Backend on Remote Server
    # ==========================================================================
    - job_name: "lms-backend"
      metrics_path: "/v1/observability/prometheus-metrics"
      
      # API key authentication (must match HEADERSAPIKEY in backend .env)
      authorization:
          type: "ApiKey"
          credentials: "YOUR_API_KEY"  # <-- Replace with your HEADERSAPIKEY
      
      # For HTTPS (recommended for production)
      scheme: https
      tls_config:
          # Set to true if using self-signed certificate
          insecure_skip_verify: false
      
      static_configs:
          - targets: ["YOUR_SERVER_DOMAIN"]  # <-- e.g., "lms.c3ihub.iitk.ac.in" or "123.45.67.89:3000"
            labels:
                service: "lms-backend"
                environment: "production"

      # Optional: Relabel to clean up instance label
      relabel_configs:
          - source_labels: [__address__]
            target_label: instance
            replacement: "production-backend"

    # ==========================================================================
    # LMS Worker on Remote Server (if separate)
    # ==========================================================================
    # Uncomment if worker has its own metrics endpoint
    # - job_name: "lms-worker"
    #   metrics_path: "/metrics"
    #   scheme: https
    #   static_configs:
    #       - targets: ["YOUR_SERVER_DOMAIN:WORKER_PORT"]
    #         labels:
    #             service: "lms-worker"
    #             environment: "production"

    # ==========================================================================
    # Prometheus Self-Monitoring (local)
    # ==========================================================================
    - job_name: "prometheus"
      static_configs:
          - targets: ["localhost:9090"]
            labels:
                service: "prometheus"
